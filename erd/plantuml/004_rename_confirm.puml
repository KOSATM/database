@startuml

!theme plain
hide circle
skinparam linetype ortho

' =========================================
' 1. ENUM & TYPES
' =========================================
enum image_action_type {
  SAVE_ONLY
  EDIT_ITINERARY
  REPLACE
}

enum checklist_category {
  PACKING
  CLOTHES
  DOCUMENT
  ETC
}

' =========================================
' 2. ENTITIES (TABLES)
' =========================================

package "User & Auth" {
  entity users {
    *id : BIGSERIAL <<PK>>
    --
    name : VARCHAR(50)
    email : VARCHAR(1000)
    provider : VARCHAR(50)
    ...
  }

  entity user_identities {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    provider : VARCHAR(50)
  }

  entity sns_tokens {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    user_access_token : TEXT
    ...
  }
}

package "Travel Planning" {
  entity travel_plans {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    budget : DECIMAL
    start_date : DATE
    end_date : DATE
    is_ended : BOOLEAN
  }

  entity travel_plan_snapshots {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    version_no : INT
    snapshot_json : JSON
  }

  entity travel_days {
    *id : BIGSERIAL <<PK>>
    --
    *travel_plan_id : BIGINT <<FK>>
    day_index : SMALLINT
    plan_date : DATE
  }

  entity travel_places {
    *id : BIGSERIAL <<PK>>
    --
    *day_id : BIGINT <<FK>>
    place_name : VARCHAR(64)
    lat : NUMERIC
    lng : NUMERIC
    expected_cost : DECIMAL
    start_at : TIMESTAMPTZ
    end_at : TIMESTAMPTZ
  }

  entity current_activities {
    *id : BIGSERIAL <<PK>>
    --
    *travel_place_id : BIGINT <<FK>>
    actual_cost : DECIMAL
    memo : TEXT
    ended_at : TIMESTAMPTZ
  }
}

package "Review & Social" {
  entity review_posts {
    *id : BIGSERIAL <<PK>>
    --
    *travel_plan_id : BIGINT <<FK>>
    *review_style_id : BIGINT <<FK>>
    content : TEXT
    is_posted : BOOLEAN
  }

  entity review_photo_groups {
    *id : BIGSERIAL <<PK>>
    --
    *review_post_id : BIGINT <<FK>>
  }

  entity review_photos {
    *id : BIGSERIAL <<PK>>
    --
    *group_id : BIGINT <<FK>>
    file_url : TEXT
    lat : NUMERIC
    lng : NUMERIC
  }

  entity review_hashtag_groups {
    *id : BIGSERIAL <<PK>>
    --
    *review_post_id : BIGINT <<FK>>
  }

  entity review_hashtags {
    *id : BIGSERIAL <<PK>>
    --
    *group_id : BIGINT <<FK>>
    name : VARCHAR(100)
    is_selected : BOOLEAN
  }
}

package "AI Analysis" {
  entity ai_review_analysis {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    *review_post_id : BIGINT <<FK>>
    prompt_text : TEXT
    input_json : JSONB
    output_json : JSONB
  }

  entity ai_review_styles {
    *id : BIGSERIAL <<PK>>
    --
    *review_analysis_id : BIGINT <<FK>>
    name : VARCHAR(150)
  }

  entity ai_review_hashtags {
    *id : BIGSERIAL <<PK>>
    --
    *review_analysis_id : BIGINT <<FK>>
    name : VARCHAR(100)
  }
}

package "Places & Search" {
  entity places {
    *id : BIGSERIAL <<PK>>
    --
    name : VARCHAR(255)
    place_type : VARCHAR(500)
    lat : NUMERIC
    lng : NUMERIC
  }

  entity image_search_places {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    action_type : ENUM
  }

  entity image_search_results {
    *id : BIGSERIAL <<PK>>
    --
    *image_search_places_id : BIGINT <<FK>>
    *place_id : BIGINT <<FK>>
    is_selected : BOOLEAN
  }

  entity toilets {
    *id : BIGSERIAL <<PK>>
    --
    name : VARCHAR(255)
    lat : NUMERIC
    lng : NUMERIC
  }
}

package "Chat & Memory" {
  entity chat_memories {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    agent_name : VARCHAR(50)
    content : TEXT
  }

  entity chat_memory_vectors {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    agent_name : VARCHAR(50)
    embedding : VECTOR(1536)
  }
}

package "Checklist" {
  entity checklists {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    day_index : SMALLINT
  }

  entity checklist_items {
    *id : BIGSERIAL <<PK>>
    --
    *checklist_id : BIGINT <<FK>>
    category : ENUM
    is_checked : BOOLEAN
  }
}

package "Hotel & Payment" {
  entity hotel_bookings {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : BIGINT <<FK>>
    hotel_id : BIGINT
    total_price : NUMERIC
    status : VARCHAR
  }

  entity payment_transactions {
    *id : BIGSERIAL <<PK>>
    --
    *hotel_booking_id : BIGINT <<FK>>
    amount : DECIMAL
    status : VARCHAR
  }
}

' =========================================
' 3. RELATIONSHIPS (GLOBAL)
' =========================================
' Users
users ||..o{ user_identities
users ||..o{ sns_tokens

' Travel
users ||..o{ travel_plans
users ||..o{ travel_plan_snapshots
travel_plans ||..o{ travel_days
travel_days ||..o{ travel_places
travel_places ||..o{ current_activities

' Review Post
travel_plans ||..o{ review_posts
review_posts ||..o{ review_photo_groups
review_photo_groups ||..o{ review_photos
review_posts ||..o{ review_hashtag_groups
review_hashtag_groups ||..o{ review_hashtags

' AI & Styles
users ||..o{ ai_review_analysis
review_posts ||..o{ ai_review_analysis
ai_review_analysis ||..o{ ai_review_styles
ai_review_analysis ||..o{ ai_review_hashtags
' Selected style FK
ai_review_styles ||..o{ review_posts : "selected style"

' Search & Places
users ||..o{ image_search_places
image_search_places ||..o{ image_search_results
places ||..o{ image_search_results

' Chat
users ||..o{ chat_memories
users ||..o{ chat_memory_vectors

' Checklist
users ||..o{ checklists
checklists ||..o{ checklist_items

' Hotel
users ||..o{ hotel_bookings
hotel_bookings ||..o{ payment_transactions

title **Global ERD (All Tables)**

' =========================================
' PAGE 2: User & Travel Planning
' =========================================
newpage

package "User Domain" {
    entity users
    entity user_identities
    entity sns_tokens
}

package "Travel Planning Domain" {
    entity travel_plans
    entity travel_days
    entity travel_places
    entity current_activities
    entity travel_plan_snapshots
}

users ||..o{ user_identities
users ||..o{ sns_tokens
users ||..o{ travel_plans
users ||..o{ travel_plan_snapshots

travel_plans ||..o{ travel_days
travel_days ||..o{ travel_places
travel_places ||..o{ current_activities

title **Cluster 1: User & Travel Planning**

' =========================================
' PAGE 3: Review, Social & AI
' =========================================
newpage

package "Review & Social" {
    entity review_posts
    entity review_photo_groups
    entity review_photos
    entity review_hashtag_groups
    entity review_hashtags
}

package "AI Analysis" {
    entity ai_review_analysis
    entity ai_review_styles
    entity ai_review_hashtags
}

' Review Internal
review_posts ||..o{ review_photo_groups
review_photo_groups ||..o{ review_photos
review_posts ||..o{ review_hashtag_groups
review_hashtag_groups ||..o{ review_hashtags

' AI Relation
review_posts ||..o{ ai_review_analysis : "triggers"
ai_review_analysis ||..o{ ai_review_styles : "generates"
ai_review_analysis ||..o{ ai_review_hashtags : "generates"

' Selection Feedback
ai_review_styles ||..o{ review_posts : "User selects style"

title **Cluster 2: Review, Social & AI Analysis**

' =========================================
' PAGE 4: Search, Places & Utilities
' =========================================
newpage

package "Image Search" {
    entity image_search_places
    entity image_search_results
    entity places
}

package "Utilities (Chat, List, Hotel)" {
    entity chat_memories
    entity chat_memory_vectors
    entity checklists
    entity checklist_items
    entity hotel_bookings
    entity payment_transactions
}

' Search
image_search_places ||..o{ image_search_results
places ||..o{ image_search_results

' Checklist
checklists ||..o{ checklist_items

' Hotel
hotel_bookings ||..o{ payment_transactions

title **Cluster 3: Search, Places & Utilities**

@enduml